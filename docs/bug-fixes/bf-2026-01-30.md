# Claude Chrome Stream - Bug Fixes Summary

**Date:** 2026-01-30

## TypeScript Build Errors

| Issue | Fix |
|-------|-----|
| Unused imports/variables (TS6133) | Removed across multiple files |
| Missing type declarations for `pixelmatch`/`pngjs` | Installed `@types/pixelmatch` and `@types/pngjs` |
| Anthropic SDK type errors | Used `as unknown as` casts and beta API |
| CDP type incompatibility | Made `timestamp` optional in `CDPScreencastFrameEvent.metadata` |

## Runtime Errors

### 1. Unhandled Error Event Crash
**File:** `src/ChromeStreamController.ts`

Node.js crashed when error events were emitted with no listeners.

**Fix:** Check `listenerCount('error') > 0` before emitting errors.

---

### 2. Missing tool_result Blocks (Anthropic API Validation)
**File:** `src/SonnetBridge.ts`

API rejected requests when `tool_use` blocks weren't followed by `tool_result`.

**Fix:** Added `addToolResultToHistory()` method to record results without making an API call.

---

### 3. Nested Tool Calls Not Handled
**File:** `src/index.ts`

Agent only processed first response's tool calls, missing subsequent ones from API responses.

**Fix:** Added while loop to process responses from `addToolResult`/`addScreenshotResult` that may contain additional `tool_use` blocks.

---

### 4. Browser Disconnection/Crashes
**File:** `src/BrowserManager.ts`

Chrome processes dying mid-operation.

**Fixes:**
- Added `pipe: true` for stable CDP connection
- Added `protocolTimeout: 300000` (5 minutes)
- Disabled GPU (`--disable-gpu`, `--disable-software-rasterizer`)
- Added CDP heartbeat (ping every 5 seconds)
- Added sandbox flags (`--no-sandbox`, `--disable-setuid-sandbox`, `--disable-dev-shm-usage`)

---

### 5. Step Counter Showing 1 Instead of Actual Actions
**Files:** `src/index.ts`, `src/cli.ts`

Only counted outer loop iterations, not nested tool calls.

**Fix:** Added `totalActions` counter and `onAction` callback to track individual browser actions.

---

### 6. Claude's Summaries Not Displayed
**Files:** `src/index.ts`, `src/cli.ts`

Final response text wasn't being returned or printed to console.

**Fix:** Added `finalResponse` field to return value and `onComplete` callback for displaying results.

---

### 7. Spurious Browser Disconnect Errors at Cleanup
**Files:** `src/BrowserManager.ts`, `src/index.ts`

Disconnect error messages appeared during intentional shutdown.

**Fix:** Added `isClosing` and `isShuttingDown` flags to suppress expected disconnect events during cleanup.

---

## Files Modified

| File | Changes |
|------|---------|
| `src/BrowserManager.ts` | Stability improvements, heartbeat, graceful shutdown |
| `src/ChromeStreamController.ts` | Error handling with listener check |
| `src/SonnetBridge.ts` | SDK type fixes, `addToolResultToHistory()` method |
| `src/index.ts` | Nested tool call handling, action tracking, error handling |
| `src/cli.ts` | Config loading, improved output display |
| `src/InputController.ts` | Debug logging |
| `src/StreamProcessor.ts` | Type fixes |

## Result

The command now runs successfully:

```bash
npx claude-chrome-stream run \
  --url "https://news.ycombinator.com" \
  --task "Find and summarize the top 3 stories"
```

Output includes:
- Action-by-action progress
- Accurate action count
- Claude's full response/summary
- Clean shutdown (no spurious errors)
